<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<link rel="stylesheet" href="style.css" />
	<script src="http://code.jquery.com/jquery-1.7.1.js"></script>
	<script src="script/common.js"></script>
	<script src="script/alerts.js"></script>
	<title>Application Test</title>
	
	<script>
	//~ var lastUpdate = new Date(0);
	var rest = "http://localhost:1337";
	fetchAlerts(handleResponse);
	//~ var nbRequests = 0;
	
	//~ $(document).ready( function() {
		//~ window.setInterval(refresh, 1000);
	//~ });
	
	//~ function refresh() {
		//~ if(nbRequests > 0) {
			//~ console.log('Waiting the end of the last Request');
			//~ return;
		//~ }
		//~ var toDate = new Date();
		
		//~ var req = {
			//~ "from" : dateToString(lastUpdate),
			//~ "to" : dateToString(toDate)
		//~ };
		//~ nbRequests++;
		//~ $.post(rest + '/alerts',
		  //~ JSON.stringify(req),
		  //~ handleResponse,
		  //~ "json");
		
		//~ lastUpdate = toDate;
	//~ }
	
	function handleResponse(data) {
		console.log(JSON.stringify(data));
		for(var i in data.alerts) {
			var a = data.alerts[i];
			var notif = "";
			var d = new Date(a.time);
			notif += dateToString(d) + " : ";
			notif += "Alerte " + a.id + " (" + a.nom + ")</br>Déclenchée par les capteurs : ";
			for(var j in a.sensors) {
				if(j != 0) {
					notif += ", ";
				}
				notif += a.sensors[j].idCapteur;
				notif += " (type:" + a.sensors[j].type;
				notif += ", global à la pièce:" + (a.sensors[j].isGlobal ? "oui" : "non") + ")";
			}
			addNotification(notif);
			
		}
		//~ nbRequests--;
	}

	
	function addNotification(notif) {
		var newElem = "<li><div class=\"warning\">"/* + new Date().getHours() + ":" + new Date().getMinutes() + ":" + new Date().getSeconds() + " "*/ + notif + "</div></li>";
		$("#listNotifs").html(newElem + $("#listNotifs").html());
	}
	</script>
	
</head>

<body>

	<header id="header" class="branding" role="banner">
		<hgroup>
		<div class="retourTdB">
			<a href="accueil.html">
			<img src="images/retour.png" alt="retour" width="40" height="40"/>
			</a>
		</div>
		<h1>Notifications<h1>
		</hgroup>
	</header>

	<section id="notifications">
	<ol id="listNotifs">
		<!--
		<li><div class="info">Notification 1</div></li>
		<li><div class="warning">Notification 2</div></li>
		<li><div class="info">Notification 3</div></li>
		-->
	</ol>
	</section>
	

	<footer>Copyright 2012 - Hexanome H4311</footer>
	
</body>

</html>
