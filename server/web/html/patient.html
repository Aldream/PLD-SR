<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<link rel="stylesheet" href="style.css" />
	<script src="http://code.jquery.com/jquery-1.7.1.js"></script>
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script src="common.js"></script>
	<title>RiTHM - Informations du Patient</title>
	
	<script>
	google.load("visualization", "1", {packages:["corechart"]});
	google.setOnLoadCallback(loadGCharts);
	
	var gChartsSettings = {
		loaded: false,
		options: {
			width: 500,
			height: 300,
			animation: {
				duration: 500,
				easing: 'in'
			}
		}
	}
	
	  var options = {title:'Sensor variation the last hour',
				 width: 400,
				 height: 300,
				 vAxis: {title: "Temp"},
				 hAxis: {title: "Time"},
				 animation:{
			duration: 500,
			easing: 'in'
	  },
	};
	
	  // Instantiate and draw our chart, passing in some options.
      $(document).ready( function() {
	  
	  var chart = new google.visualization.LineChart(document.getElementById('chart_div'))
	  
	  var randomnumber = Math.floor(Math.random()*11)
	  // Create the data table.
	  var data = new google.visualization.DataTable();
	  data.addColumn('string', 'TimeSensor');
	  data.addColumn('number', 'Temperature');
		  
      // Callback that creates and populates a data table, 
      // instantiates the pie chart, passes in the data and
      // draws it.
      var drawChart = function drawChart() {

		chart.draw(data, options);
		};
		
		/*$('#b1').click( drawChart);*/
		
		drawChart();
			
		});
	

	var rest = "http://localhost:1337";
	
	function loadGCharts() {
		gChartsSettings.loaded = true;
	}
	
	function initChart(data) {
		var randomnumber = Math.floor(Math.random()*11)

		var data = new google.visualization.DataTable();
		  data.addColumn('string', 'TimeSensor');
		  data.addColumn('number', 'Temperature');
		  for( var i in data.hits){
			var mesure = data.hits[i];
			data.addRows([mesure.time, mesure.value]);
		  }
	}
	
	function updateChart(sensorId, values) {
			  	
	}
	
	function presentationSensors(data) {
		if (data.count == 0) {
			$("#sensors").html("<h2>Ce patient ne génère aucune données.</h2>");
			return;
		}
		
		var content = "";
		for(var i in data.hits) {
			var sensor = data.hits[i];
			content+="<h3>Capteur :"+sensor.numeroCapteur+"<div id=\"chart_"+sensor.id+"\"></div></h3>"
			$("#sensors").html(content);
			getSensorValues(sensor.id, initChart, new Date().getTime() - 3600000, sensor.type);
		}
	}
	
	function presentationPatient(data) {
		
		if (data.count == 0) {
			$("#resume").html("<h2>Ce patient n'existe pas.</h2>");
			return;
		}

		var patient = data.hits[0];
		getSensors(patient.id, presentationSensors);
		
		var content = '<h2>' + ((patient.isMan) ? "M" : "Mme") + ' ' + 
			patient.nom + '</h2><div class="chambre">' +
			'<figure>' +
				'<img src="images/chambre.jpg" alt="Chambre" width="150"' + 
				'height="150">' +
				'Raison de l\'hospitalisation : ' + patient.raisonHospitalisation +
			'</figure></div>';
		
		$("#resume").html(content);
	}
	
	function getPatients(callback) {
		$.post(rest + '/patients',
		  {},
		  callback,
		  "json");
	}
	
	function getPatient(id, callback) {
		$.post(rest + '/patients',
		  {"id":id},
		  callback,
		  "json");
	}
	
	function getSensorValues(idSensor, callback, from, to, typeMesure) {
		var req = {
			sensors: [
				{
					id: idSensor,
					from: new Date(from).toString("yyyy/MM/dd HH:mm:ss"),
					type: typeMesure
				}
			]
		};
		if(to) req.sensors[0].to =  new Date(to).toString("yyyy/MM/dd HH:mm:ss")
		
		$.post(rest + '/sensors',
		  req,
		  callback,
		  "json");
	}
	
	function getSensors(idPatient, callback) {
		var req = {
			idPatient: idPatient
		};
		$.post(rest + '/list_sensors',
		  req,
		  callback,
		  "json");
	}
	
	$(document).ready(function() {
		var idPatient = $.getUrlVar('id');
		getPatient(idPatient, presentationPatient); // initially retrieves patient values on first time.
		$("#returnLink").attr("href", "room.html?id=" + $.getUrlVar('roomId'));
	});
	</script>
</head>

<body>

<header id="header" class="branding" role="banner">
	<div class="retourTdB">
		<a href="index.html">
		<img src="images/retour.png" alt="retour" width="40" height="40"/>
		</a>
	</div>
	<hgroup>
	<h1>Patient</h1>
	</hgroup>
	<div class="alerte">
		<!--TODO: ref vers la chambre qui pose probleme !! -->
		<a href="room.html">
		<figure>
			<img src="images/attention2.png" alt="alerte" width="60" height="50">
		</figure>
		</a>
	</div> 
</header>

<div id="wrapper">
	
	<section id="resume">
	
	</section>
	
	<section id="sensors">
	
	</section>
	
	<section id="stats">
		<div id="charts">
		<h2>Temperature variation</h2>
		<!--Div that will hold the pie chart-->
		<div id="chart_div" style="width:400; height:300"></div>
		<input type="button" id="b1" value="add value" />
		</div>
	</section>

</div>
	
<footer>Copyright 2012 - Hexanome H4311</footer>

</body>

</html>
